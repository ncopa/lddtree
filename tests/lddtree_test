#!/usr/bin/env atf-sh

. $(atf_get_srcdir)/test_env.sh
: ${SH=/bin/sh}

lddtree="$SRCDIR"/lddtree.sh

init_tests \
	lddtree_usage \
	lddtree_version \
	lddtree_sh \
	lddtree_sh_list \
	lddtree_sh_all \
	lddtree_sh_debug

lddtree_usage_body() {
	# usage to stdout, empty stderr
	atf_check -o match:"Usage:" "$SH" "$lddtree" -h
	atf_check -o match:"Usage:" "$SH" "$lddtree" --help
	# usage to stderr, empty stdout
	atf_check -s exit:1 -e match:"Usage:" "$lddtree"
}

lddtree_version_body() {
	for arg in -V --version; do
		atf_check -s exit:0 \
			-o match:'lddtree-[0-9]*.[0-9]*' \
			"$SH" "$lddtree" "$arg"
	done
}

# test without -R
lddtree_sh_body() {
	atf_check -s exit:0 \
		-o match:'sh => /bin/sh \(interpreter .*\)' \
		"$SH" "$lddtree" /bin/sh
}

# test without -R, flat output
# should only output lines prefixed with /
lddtree_sh_list_body() {
	for arg in -l --list; do
		atf_check -s exit:0 \
			-o match:'/bin/sh' \
			-o not-match:'\(interpreter .*\)' \
			-o not-match:'^[^/]' \
			"$SH" "$lddtree" "$arg" /bin/sh
	done
}

lddtree_sh_all_body() {
	for arg in -a --all; do
		atf_check -s exit:0 \
			-o match:'/bin/sh' \
			-o match:'\(interpreter .*\)' \
			"$SH" "$lddtree" "$arg" /bin/sh
	done
}

lddtree_sh_debug_body() {
	for arg in -x --debug; do
		atf_check -s exit:0 \
			-o match:'/bin/sh' \
			-o match:'\(interpreter .*\)' \
			-e match:'^\+' \
			"$SH" "$lddtree" "$arg" /bin/sh
	done
}
